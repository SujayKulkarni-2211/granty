{% extends "base.html" %}

{% block title %}AI Chat - {{ project.title }}{% endblock %}

{% block styles %}
<style>
.chat-container {
    height: 70vh;
    display: flex;
    flex-direction: column;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    margin-bottom: 20px;
}

.message {
    margin-bottom: 15px;
    display: flex;
    align-items: flex-start;
}

.message.user {
    justify-content: flex-end;
}

.message.ai {
    justify-content: flex-start;
}

.message-content {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
}

.message.user .message-content {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border-bottom-right-radius: 4px;
}

.message.ai .message-content {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border-bottom-left-radius: 4px;
}

.message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 10px;
    font-size: 14px;
}

.message.user .message-avatar {
    background: var(--accent);
    color: white;
    order: 2;
}

.message.ai .message-avatar {
    background: var(--primary);
    color: white;
}

.chat-input-container {
    display: flex;
    gap: 10px;
    align-items: flex-end;
}

.chat-input {
    flex: 1;
    resize: none;
    min-height: 50px;
    max-height: 120px;
}

.typing-indicator {
    display: none;
    padding: 10px;
    font-style: italic;
    color: rgba(255, 255, 255, 0.7);
}

.typing-indicator .dots {
    display: inline-block;
}

.typing-indicator .dots::after {
    content: '...';
    animation: dots 1.5s infinite;
}

@keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}

.quick-actions {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.quick-action-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.quick-action-btn:hover {
    background: var(--accent);
    border-color: var(--accent);
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 style="color: white;"><i class="fas fa-robot"></i> AI Assistant</h1>
                <p class="lead" style="color: aliceblue;">Chat with AI about: {{ project.title }}</p>
            </div>
            <div>
                <a href="{{ url_for('editor', draft_id=project.id) }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left"></i> Back to Editor
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-comments"></i> AI Chat Assistant</h5>
            </div>
            <div class="card-body">
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        {% if chat_history %}
                            {% for chat in chat_history %}
                                <div class="message user">
                                    <div class="message-content">{{ chat.message }}</div>
                                    <div class="message-avatar"><i class="fas fa-user"></i></div>
                                </div>
                                <div class="message ai">
                                    <div class="message-avatar"><i class="fas fa-robot"></i></div>
                                    <div class="message-content">{{ chat.response }}</div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="message ai">
                                <div class="message-avatar"><i class="fas fa-robot"></i></div>
                                <div class="message-content">
                                    Hello! I'm your AI assistant. I can help you improve your project, suggest content, restructure sections, and answer questions about grant writing. How can I help you today?
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="typing-indicator" id="typingIndicator">
                        <i class="fas fa-robot"></i> AI is thinking<span class="dots"></span>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="sendQuickMessage('How can I improve my project?')">
                            Improve Project
                        </button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('Suggest better content structure')">
                            Restructure Content
                        </button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('What are the key elements missing?')">
                            Missing Elements
                        </button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('Make it more compelling')">
                            Make Compelling
                        </button>
                    </div>
                    
                    <div class="chat-input-container">
                        <textarea 
                            class="form-control chat-input" 
                            id="chatInput" 
                            placeholder="Ask me anything about your project..."
                            rows="2"></textarea>
                        <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Restructure Modal -->
<div class="modal fade" id="restructureModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: rgba(255, 255, 255, 0.95); color: #2c3e50;">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-magic"></i> Restructure Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Provide instructions for how you want to restructure your content:</p>
                <textarea class="form-control" id="restructureInstructions" rows="4" 
                          placeholder="e.g., Make it more formal, add more technical details, reorganize sections..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="restructureContent()">
                    <i class="fas fa-magic"></i> Restructure
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const projectId = "{{ project.id }}";

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessage(message, 'user');
    input.value = '';
    
    // Show typing indicator
    showTyping();
    
    // Send to API
    fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            project_id: projectId,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        hideTyping();
        if (data.success) {
            addMessage(data.response, 'ai');
        } else {
            addMessage('Sorry, I encountered an error. Please try again.', 'ai');
        }
    })
    .catch(error => {
        hideTyping();
        addMessage('Sorry, I encountered an error. Please try again.', 'ai');
    });
}

function sendQuickMessage(message) {
    document.getElementById('chatInput').value = message;
    sendMessage();
}

function addMessage(content, type) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    
    if (type === 'user') {
        messageDiv.innerHTML = `
            <div class="message-content">${content}</div>
            <div class="message-avatar"><i class="fas fa-user"></i></div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-avatar"><i class="fas fa-robot"></i></div>
            <div class="message-content">${content}</div>
        `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTyping() {
    document.getElementById('typingIndicator').style.display = 'block';
    document.getElementById('sendBtn').disabled = true;
}

function hideTyping() {
    document.getElementById('typingIndicator').style.display = 'none';
    document.getElementById('sendBtn').disabled = false;
}

function restructureContent() {
    const instructions = document.getElementById('restructureInstructions').value.trim();
    if (!instructions) return;
    
    fetch('/api/restructure-content', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            project_id: projectId,
            instructions: instructions
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Content restructured successfully! Check the preview page to see changes.');
            bootstrap.Modal.getInstance(document.getElementById('restructureModal')).hide();
        } else {
            alert('Error restructuring content: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error restructuring content: ' + error.message);
    });
}

// Enter key to send message
document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Auto-resize textarea
document.getElementById('chatInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});
</script>
{% endblock %}
